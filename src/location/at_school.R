# Annotate each standardized location point with whether it is within
# 100 meters of a Colorado high school

library(readr)
library(dplyr)
library(geosphere)

std_locs <- read_rds("data/processed/std_locations_filled.rds")
schools <- read_rds("data/processed/all_school_address.rds")

# Use only non-missing points
std_locs <- na.omit(std_locs)

at_school <- rep(NA, nrow(std_locs))

for (i in 1:nrow(std_locs)) {
  at_school[i] <-
    any(
      distCosine(
        c(std_locs[[i, "longitude"]], std_locs[[i, "latitude"]]),
        cbind(schools$longitude, schools$latitude)
        ) <= 100
      )
}

std_locs["at_school"] <- at_school

# Remove individuals where we seem to have failed to identify a school
# (time at zero)
to_remove <- c(
  "10001072212597412326",
  "10232520423395103206",
  "10473343825718415846",
  "10523881975798960614",
  "10629760407091286502",
  "10701338501517414885",
  "11721367829140869606",
  "11232862644044960230",
  "12648373229291377126",
  "10988621683621433830",
  "12376380409293705701",
  "12563054890317189606",
  "13134811961961615845",
  "12895567701863240166",
  "12758166492366115301",
  "13237375926974550502",
  "13328117410434126310",
  "13658636631925199334",
  "14025851128752247269",
  "14744394060635705830",
  "14701744522713764326",
  "14365939804201161190",
  "14154650187562095077",
  "14871033358480511461",
  "14960215945076347365",
  "15030571462218158566",
  "15105520598946550245",
  "15264921250408305126",
  "16066070780119618021",
  "15651941071501595109",
  "15626086661164831205",
  "15536523391384949222",
  "15404370734066962918",
  "16240839238530568677",
  "16489144711640453606",
  "16861585393037480421",
  "17033925671561269734",
  "17115357253202481637",
  "17709342514169123301",
  "18050943746688815590",
  "1859993660825670117",
  "1902218853617111526",
  "2196099453246181862",
  "2242992076439884261",
  "2905385763218723302",
  "2945633638677484006",
  "3136719456765022694",
  "3372328670887809510",
  "3505404453353755110",
  "3562092811494232549",
  "3625544947942953445",
  "3691552553249673702",
  "4375018766117966310",
  "4014097478797169125",
  "4861191443618206181",
  "4893978395279626725",
  "5394553637001499110",
  "5865271671533212134",
  "6344070633913061862",
  "6487928271721140710",
  "6699992588549034469",
  "6718230241661948390",
  "6946823184587887077",
  "7616866149110190566",
  "7571414726053007846",
  "748317496465756646",
  "7207468682154086886",
  "7186878559791682021",
  "8035821379331625446",
  "8097104607370940902",
  "8109300829615821285",
  "8562042324871418342",
  "9159551478131659238",
  "9117122467906458086",
  "8916771635386323430",
  "9561319888524022245",
  "9574345145543037413"
)
std_locs <- filter(std_locs, !(Michigan_ID %in% to_remove))

write_rds(std_locs, "data/processed/at_school.rds")
