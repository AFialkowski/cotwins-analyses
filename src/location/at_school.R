# Annotate each standardized location point with whether it is within
# 100 meters of a Colorado high school

library(readr)
library(dplyr)
library(geosphere)

std_locs <- read_rds("data/processed/std_locations_filled.rds")
schools <- read_rds("data/processed/all_school_address.rds")

# Use only non-missing points
std_locs <- na.omit(std_locs)

at_school <- rep(NA, nrow(std_locs))

for (i in 1:nrow(std_locs)) {
  at_school[i] <-
    any(
      distCosine(
        c(std_locs[[i, "longitude"]], std_locs[[i, "latitude"]]),
        cbind(schools$longitude, schools$latitude)
        ) <= 100
      )
}

std_locs["at_school"] <- at_school

write_rds(std_locs, "data/processed/at_school_unfiltered.rds")

# Remove individuals where we seem to have failed to identify a school
# (that is, looking at points before age 18, are they all at zero,
# or is there a period of four or more weeks where they are all at zero)
to_remove <- c(
  "10001072212597412326",
  "10097309509279027686",
  "10232520423395103206",
  "10473343825718415846",
  "10523881975798960614",
  "10629760407091286502",
  "10671282618011816421",
  "10701338501517414885",
  "10749966822447387109",
  "11232862644044960230",
  "10988621683621433830",
  "10956220549324870118",
  "10802371837027553765",
  "11721367829140869606",
  "12087047223254061541",
  "12261601323235348966",
  "12285629381245014501",
  "12376380409293705701",
  "12895567701863240166",
  "12758166492366115301",
  "12648373229291377126",
  "12563054890317189606",
  "13134811961961615845",
  "13147678603472998885",
  "13222044248511287781",
  "13229567082602041830",
  "13237375926974550502",
  "13328117410434126310",
  "14350241506328383974",
  "14154650187562095077",
  "14025851128752247269",
  "13991330062006620645",
  "13959228388057289189",
  "13658636631925199334",
  "14494020510344745446",
  "14701744522713764326",
  "14744394060635705830",
  "14871033358480511461",
  "15404370734066962918",
  "15268244675444609510",
  "15264921250408305126",
  "15178091693452956134",
  "15123069704779272677",
  "15105520598946550245",
  "15104960735136453094",
  "15030571462218158566",
  "14960215945076347365",
  "15536523391384949222",
  "15612587683657683430",
  "15626086661164831205",
  "15651941071501595109",
  "16066070780119618021",
  "16194037714798121446",
  "17115357253202481637",
  "17033925671561269734",
  "16861585393037480421",
  "16489144711640453606",
  "16240839238530568677",
  "17709342514169123301",
  "1902218853617111526",
  "18050943746688815590",
  "2196099453246181862",
  "2242992076439884261",
  "2615817593484808677",
  "3372328670887809510",
  "3136719456765022694",
  "2945633638677484006",
  "2905385763218723302",
  "3625544947942953445",
  "3691552553249673702",
  "4014097478797169125",
  "4861191443618206181",
  "4375018766117966310",
  "5394553637001499110",
  "6344070633913061862",
  "5981024399985218021",
  "5865271671533212134",
  "5818180864071963110",
  "6574513473549046245",
  "6631282003399152102",
  "6699992588549034469",
  "6699992588549034469",
  "6772407588002599397",
  "681211369319698917",
  "6946823184587887077",
  "7571414726053007846",
  "748317496465756646",
  "7428381008752021990",
  "7238061889468436966",
  "7207468682154086886",
  "7186878559791682021",
  "7616866149110190566",
  "8035821379331625446",
  "8097104607370940902",
  "8109300829615821285",
  "8916771635386323430",
  "8562042324871418342",
  "843339933702820325",
  "9117122467906458086",
  "9574345145543037413",
  "9561319888524022245"
)
std_locs <- filter(std_locs, !(Michigan_ID %in% to_remove))

write_rds(std_locs, "data/processed/at_school.rds")
