---
title: "Moving Out and Substance Use"
output: html_notebook
---

For the CoTwins grant application, we want to test whether twins increase their substance use when they move out of their parents' home. Previously, I manually identified twins whose proportion of locations recorded within 100 meters of home each day dropped off sharply and consistently to zero or mostly zero, after a substantial portion of time where this was not the case. See `src/plots/at_home_plot.R` and `at_home_plot()` in `src/plots/utils.R` for the visualizations I used to do this. I also identified the date when the twin moved out. This information has been stored in `data/processed/twin_moves.csv`.

```{r}
library(readr)
library(dplyr)
library(lubridate)

twin_moves <- read_csv("../data/processed/twin_moves.csv", col_types = "cc")
twin_moves$move_date <- ymd(twin_moves$move_date)
twin_moves["n_before"] <- NA
twin_moves["n_after"] <- NA
twin_moves["any_frac_before"] <- NA
twin_moves["any_frac_after"] <- NA
twin_moves["drinks_per_day_before"] <- NA
twin_moves["drinks_per_day_after"] <- NA
twin_moves["mar_days_per_week_before"] <- NA
twin_moves["mar_days_per_week_after"] <- NA
twin_moves["alc_days_per_week_before"] <- NA
twin_moves["alc_days_per_week_after"] <- NA

remote_sub_use <- read_rds("../data/processed/remote_substance_use.rds")
```

We plan to compare average substance use in the three months before the putative move to average substance use more than a week after (most of the moves were in August 2017, so we don't have enough data to go further). Let's see how many completed Checking In responses each twin has in that time frame.

```{r}
for (i in seq(to = nrow(twin_moves))) {
  twin_answers <- filter(remote_sub_use, user_id == twin_moves[[i, 1]])
  twin_moves[[i, 3]] <- nrow(filter(twin_answers, date_completed < twin_moves[[i, 2]], date_completed > twin_moves[[i, 2]] - months(3)))
  twin_moves[[i, 4]] <- nrow(filter(twin_answers, date_completed >= twin_moves[[i, 2]] + weeks(1)))
}

twin_moves
```

```{r}
twin_moves %>% group_by(n_after) %>% summarize(n())
```

```{r}
twin_moves %>% group_by(n_before) %>% summarize(n())
```

We'll get rid of twins with no responses after the move and set the questions of interest to zero instead of missing where twins said they didn't use a substance.

```{r}
twin_moves <- filter(twin_moves, n_after > 0)

remote_sub_use$alc_quantity_drinks_per_day[remote_sub_use$any_substance_use == F | remote_sub_use$alc_use == F] <- 0
remote_sub_use$alc_freq_days_per_week[remote_sub_use$any_substance_use == F | remote_sub_use$alc_use == F] <- 0
remote_sub_use$mar_freq_times_per_day[remote_sub_use$any_substance_use == F | remote_sub_use$mar_use == F] <- 0
```


Now we get the average substance use before and after the move.

```{r}
for (i in seq(to = nrow(twin_moves))) {
  twin_answers_before <- filter(remote_sub_use, user_id == twin_moves[[i, 1]], date_completed < twin_moves[[i, 2]], date_completed > twin_moves[[i, 2]] - months(3))
  twin_answers_after <- filter(remote_sub_use, user_id == twin_moves[[i, 1]], date_completed >= twin_moves[[i, 2]] + weeks(1))
  
  twin_moves[[i, 5]] <- sum(twin_answers_before$any_substance_use) / nrow(twin_answers_before)
  twin_moves[[i, 6]] <- sum(twin_answers_after$any_substance_use) / nrow(twin_answers_after)
  
  twin_moves[[i, 7]] <- mean(twin_answers_before$alc_quantity_drinks_per_day)
  twin_moves[[i, 8]] <- mean(twin_answers_after$alc_quantity_drinks_per_day)
  
  twin_moves[[i, 9]] <- mean(twin_answers_before$mar_freq_times_per_day)
  twin_moves[[i, 10]] <- mean(twin_answers_after$mar_freq_times_per_day)
  
  twin_moves[[i, 11]] <- mean(twin_answers_before$alc_freq_days_per_week)
  twin_moves[[i, 12]] <- mean(twin_answers_after$alc_freq_days_per_week)
}
```

Based on a paired t-test, we accept the null hypothesis that there are no mean differences between the before and after conditions, except for drinks per day.
```{r}
t.test(twin_moves$any_frac_before, twin_moves$any_frac_after, paired = T)
```

```{r}
t.test(twin_moves$drinks_per_day_before, twin_moves$drinks_per_day_after, paired = T)
```

```{r}
t.test(twin_moves$mar_days_per_week_before, twin_moves$mar_days_per_week_after, paired = T)
```

```{r}
t.test(twin_moves$alc_days_per_week_before, twin_moves$alc_days_per_week_after, paired = T)
```

What if we eliminate twins who did not use any substances at all in the three months before they moved? This leaves twenty twins but we don't see a significant difference.

```{r}
twin_moves_users <- filter(twin_moves, any_frac_before > 0)
```

```{r}
t.test(twin_moves_users$any_frac_before, twin_moves_users$any_frac_after, paired = T)
```

```{r}
t.test(twin_moves_users$drinks_per_day_before, twin_moves_users$drinks_per_day_after, paired = T)
```

```{r}
t.test(twin_moves_users$mar_days_per_week_before, twin_moves_users$mar_days_per_week_after, paired = T)
```

```{r}
t.test(twin_moves_users$alc_days_per_week_before, twin_moves_users$alc_days_per_week_after, paired = T)
```

# Birth Year Distribution

```{r}
paper_data <- read_rds("../data/processed/Robin_paper-entry_2-22-17_cleaned.rds")
id_mapping <- read_csv("../data/processed/id_mapping_long.csv", col_types = "ccc")

twin_moves %>%
  left_join(id_mapping, by = c("user_id" = "alternate_id")) %>%
  left_join(paper_data, by = c("SVID" = "ID1")) %>%
  group_by(Birth_Year) %>%
  summarize(N = n())
```

